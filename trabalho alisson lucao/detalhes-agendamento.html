<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirma√ß√£o de Pagamento - Barbearia</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <style>
        /* --- ESTILOS VISUAIS --- */
        :root {
            --primary: #333333; --secondary: #f0f0f0; --accent: #A18522;
            --highlight: #D4AF37; --light: #ffffff; --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --border-radius: 20px; --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --success-color: #28a745;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--light) 0%, #f9f9f9 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow-x: hidden; }
        .background-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('imagens/Imagem do WhatsApp de 2025-11-17 √†(s) 19.55.45_787eb28d.jpg') no-repeat center center; background-size: cover; opacity: 0.1; z-index: -1; }
        
        .container { background: var(--light); border: 2px solid var(--accent); border-radius: var(--border-radius); padding: 40px 50px; max-width: 650px; width: 90%; box-shadow: var(--shadow); position: relative; z-index: 1; text-align: center; margin: 50px 0; }
        .container h1 { color: var(--accent); font-size: 2em; margin-bottom: 30px; font-weight: 700; border-bottom: 3px solid var(--highlight); padding-bottom: 15px; }
        
        /* Detalhes */
        #appointmentDetails { text-align: left; margin-bottom: 30px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed var(--secondary); font-size: 1.1em; font-weight: 500; }
        .detail-item:last-of-type { border-bottom: none; }
        .detail-label { color: var(--accent); font-weight: 600; }
        .detail-value { color: var(--primary); font-weight: 700; text-align: right; }
        #totalValue { font-size: 1.6em; color: var(--success-color); font-weight: 900; }

        /* Pagamento */
        .payment-section h2 { color: var(--primary); font-size: 1.4em; margin: 30px 0 20px 0; border-bottom: 1px solid var(--secondary); padding-bottom: 10px; text-align: left; }
        .payment-options { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .payment-option { flex: 1; max-width: 180px; padding: 20px; border: 2px solid var(--accent); border-radius: var(--border-radius); cursor: pointer; transition: var(--transition); background: var(--secondary); font-weight: 600; min-width: 150px; }
        .payment-option:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); }
        .payment-option.selected { border-color: var(--success-color); background: rgba(40, 167, 69, 0.1); box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3); }
        .payment-option i { font-size: 2em; color: var(--accent); display: block; margin-bottom: 10px; }
        .payment-option.selected i { color: var(--success-color); }

        /* Bot√µes */
        .action-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 20px; }
        .action-buttons button { flex: 1; padding: 15px 30px; border: 2px solid var(--accent); border-radius: var(--border-radius); font-size: 1.1em; font-weight: 600; cursor: pointer; transition: var(--transition); }
        #walletBrick_container { flex: 1; min-height: 48px; }
        #presencialConfirmButton { background: var(--accent); color: var(--light); border-color: var(--accent); display: none; }
        #presencialConfirmButton:hover { background: var(--highlight); border-color: var(--highlight); transform: translateY(-2px); }
        #backButton { background: var(--light); color: var(--accent); }
        #backButton:hover { background: var(--secondary); transform: translateY(-2px); }
        .error-message { color: #e94560; font-weight: 600; margin-top: 15px; text-align: center; }

        /* --- MODAL MODERNO DE CONFIRMA√á√ÉO --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.4s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-card {
            background: var(--light); padding: 40px 30px; border-radius: 25px;
            text-align: center; max-width: 380px; width: 90%;
            border: 2px solid var(--success-color);
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .modal-icon-wrapper {
            width: 90px; height: 90px; background: rgba(40, 167, 69, 0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 25px auto;
            position: relative;
        }
        .modal-icon-wrapper::after {
            content: ''; position: absolute; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid var(--success-color);
            animation: pulse 2s infinite; opacity: 0.5;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.4); opacity: 0; } }

        .modal-icon-wrapper i { font-size: 45px; color: var(--success-color); }

        .modal-card h2 { color: var(--primary); font-size: 1.6em; margin-bottom: 10px; font-weight: 700; }
        .modal-card p { color: #666; margin-bottom: 5px; font-size: 1em; line-height: 1.5; }
        .modal-card .modal-detail { font-weight: 600; color: var(--accent); margin-bottom: 30px; font-size: 1.1em; }

        .modal-card button {
            width: 100%; padding: 15px; border: none; border-radius: 15px;
            background: var(--success-color); color: white; font-size: 1.1em; font-weight: 600;
            cursor: pointer; transition: var(--transition); box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        .modal-card button:hover { transform: translateY(-3px); background: #218838; box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4); }

        @media (max-width: 650px) { .container { padding: 30px 20px; } .action-buttons { flex-direction: column; } .payment-options { flex-direction: column; align-items: center; } }
    </style>
</head>

<body>
    <div class="background-image"></div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="successModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-icon-wrapper">
                <i class="fas fa-check"></i>
            </div>
            <h2>Agendamento Confirmado!</h2>
            <p>Seu hor√°rio foi reservado com sucesso.</p>
            <p class="modal-detail">Pagamento ser√° realizado no local.</p>
            <button onclick="finalizarRedirecionamento()">OK, Entendido</button>
        </div>
    </div>

    <div class="container">
        <h1><i class="fas fa-money-check-alt"></i> Confirma√ß√£o e Pagamento</h1>

        <div id="appointmentDetails">
            <p style="text-align: center;">Carregando dados...</p>
        </div>

        <div class="payment-section">
            <h2><i class="fas fa-credit-card"></i> Escolha o M√©todo</h2>
            <input type="hidden" id="paymentMethod" required>

            <div class="payment-options">
                <div class="payment-option" onclick="selectPayment('pix', this)">
                    <i class="fas fa-qrcode"></i> PIX / Cart√£o Online
                </div>
                <div class="payment-option" onclick="selectPayment('presencial', this)">
                    <i class="fas fa-handshake"></i> Pagar no Local
                </div>
            </div>
            <p id="paymentError" class="error-message" style="display: none;">Selecione um m√©todo.</p>
        </div>
        
        <div class="action-buttons">
            <button id="backButton" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            
            <div id="walletBrick_container"></div>

            <button id="presencialConfirmButton" onclick="handleConfirmation()">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>

    <script>
        // üõë CONFIGURA√á√ïES GERAIS
        // Substitua pela sua Public Key de Produ√ß√£o ou Teste conforme necess√°rio
        const MERCADOPAGO_PUBLIC_KEY = "APP_USR-61effb37-1b99-457b-9549-2890b0442f50"; 
        const API_BASE = "http://127.0.0.1:8000";

        let currentAppointment = null;
        let mpPreferenceId = null; // Armazena o ID para n√£o gerar duplicado
        let bricksController = null; // Controle do componente visual

        const formatTime = (t) => t ? (t.includes('T') ? t.split('T')[1].substring(0,5) : t.substring(0,5)) : '--:--';

        // --- 1. BUSCAR DADOS DO AGENDAMENTO ---
        async function fetchDetails(id) {
            const container = document.getElementById('appointmentDetails');
            try {
                const res = await fetch(`${API_BASE}/agendamento/agendamentos/${id}`);
                if (!res.ok) throw new Error("Agendamento n√£o encontrado");
                
                currentAppointment = await res.json();
                const a = currentAppointment;

                // Formata√ß√µes de seguran√ßa caso venha nulo
                const data = a.data || (a.data_hora_inicio ? a.data_hora_inicio.split('T')[0] : 'N/A');
                // Tenta pegar o pre√ßo do agendamento, se n√£o tiver, pega do servi√ßo
                const preco = parseFloat(a.preco || (a.servico ? a.servico.preco : 0));
                
                // Renderiza HTML
                container.innerHTML = `
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-user"></i> Cliente:</span><span class="detail-value">${a.cliente?.nome || 'N/A'}</span></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-cut"></i> Barbeiro:</span><span class="detail-value">${a.barbeiro?.nome || 'N/A'}</span></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-scissors"></i> Servi√ßo:</span><span class="detail-value">${a.servico?.nome || 'N/A'}</span></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-calendar"></i> Data:</span><span class="detail-value">${data.split('-').reverse().join('/')}</span></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-clock"></i> Hor√°rio:</span><span class="detail-value">${formatTime(a.data_hora_inicio)} - ${formatTime(a.data_hora_fim)}</span></div>
                    <div class="detail-item" style="border-top: 2px solid var(--accent); margin-top: 15px;">
                        <span class="detail-label" style="font-size: 1.3em;">VALOR:</span>
                        <span class="detail-value" id="totalValue">R$ ${preco.toFixed(2).replace('.', ',')}</span>
                    </div>
                `;
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="error-message">Erro ao carregar dados: ${error.message}</p>`;
            }
        }

        // --- 2. GERAR PREFER√äNCIA DO MERCADO PAGO ---
        async function gerarPreferenciaMP() {
            if (!currentAppointment) {
                alert("Aguarde o carregamento dos dados do agendamento.");
                return null;
            }

            // Evita gerar nova prefer√™ncia se j√° tivermos uma (Cache simples)
            if (mpPreferenceId) {
                console.log("Usando prefer√™ncia j√° gerada:", mpPreferenceId);
                return mpPreferenceId;
            }

            const idAgendamento = new URLSearchParams(window.location.search).get('id');
            const precoNumerico = parseFloat(currentAppointment.preco || currentAppointment.servico.preco);

            // Payload estrito conforme Pydantic espera
            const payload = {
                agendamento_id: parseInt(idAgendamento),
                item: {
                    title: `Servi√ßo: ${currentAppointment.servico.nome}`,
                    quantity: 1,
                    unit_price: precoNumerico
                },
                payer_name: currentAppointment.cliente.nome,
                payer_email: currentAppointment.cliente.email || "email_padrao@barbearia.com"
            };

            try {
                const res = await fetch(`${API_BASE}/pagamentos/criar_preferencia`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("Erro Backend:", errorData);
                    throw new Error("O servidor recusou a cria√ß√£o do pagamento.");
                }

                const data = await res.json();
                console.log("Resposta Sucesso MP:", data);

                // L√≥gica robusta para encontrar o ID independente de como o Python retornou
                let prefId = null;
                if (data.id) prefId = data.id;
                else if (data.preference_id) prefId = data.preference_id;
                else if (data.response && data.response.id) prefId = data.response.id; // Caso venha aninhado

                if (!prefId) throw new Error("ID da prefer√™ncia n√£o encontrado na resposta.");

                mpPreferenceId = prefId; // Salva para n√£o precisar buscar de novo
                return prefId;

            } catch (error) {
                console.error("Falha ao gerar prefer√™ncia:", error);
                document.getElementById('walletBrick_container').innerHTML = 
                    '<p class="error-message">Erro ao iniciar pagamento. Tente recarregar.</p>';
                return null;
            }
        }

        // --- 3. RENDERIZAR BOT√ÉO (WALLET BRICK) ---
        async function renderMercadoPagoButton(prefId) {
            const container = document.getElementById('walletBrick_container');
            
            // Se j√° renderizou, n√£o faz nada
            if (bricksController) return;

            container.innerHTML = ''; // Limpa msg de "carregando"
            
            const mp = new MercadoPago(MERCADOPAGO_PUBLIC_KEY, { locale: 'pt-BR' });
            const bricksBuilder = mp.bricks();

            try {
                bricksController = await bricksBuilder.create("wallet", "walletBrick_container", {
                    initialization: {
                        preferenceId: prefId,
                    },
                    customization: {
                        texts: {
                            action: 'pay',
                            valueProp: 'security_details',
                        },
                        visual: {
                            buttonColors: {
                                dark: "#10041B", // Cor escura do bot√£o
                                light: "#D4AF37" // Cor clara (Dourado da barbearia)
                            }
                        }
                    },
                });
            } catch (e) {
                console.error("Erro ao renderizar Brick:", e);
            }
        }

        // --- 4. SELE√á√ÉO DE M√âTODO ---
        async function selectPayment(method, element) {
            // Visual: Sele√ß√£o
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('paymentMethod').value = method;
            document.getElementById('paymentError').style.display = 'none';

            const containerBrick = document.getElementById('walletBrick_container');
            const btnPresencial = document.getElementById('presencialConfirmButton');

            if (method === 'presencial') {
                // Esconde MP, Mostra Bot√£o Confirmar
                containerBrick.style.display = 'none';
                btnPresencial.style.display = 'block';
            } else {
                // Esconde Bot√£o Confirmar, Mostra MP
                btnPresencial.style.display = 'none';
                containerBrick.style.display = 'block';
                
                // Se ainda n√£o gerou, gera agora
                if (!mpPreferenceId) {
                    containerBrick.innerHTML = '<p style="margin:10px; font-weight:bold; color:#666;">Preparando pagamento seguro...</p>';
                    const id = await gerarPreferenciaMP();
                    if (id) renderMercadoPagoButton(id);
                }
            }
        }

        function handleConfirmation() {
            // Abre o MODAL MODERNO em vez do alert()
            const modal = document.getElementById('successModal');
            modal.style.display = 'flex';
            // Pequeno delay para a anima√ß√£o CSS funcionar
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function finalizarRedirecionamento() {
            window.location.href = "main.html"; // Redireciona para home
        }

        // Inicializa√ß√£o ao abrir a p√°gina
        document.addEventListener("DOMContentLoaded", () => {
            const id = new URLSearchParams(window.location.search).get('id');
            if (id) {
                fetchDetails(id);
            } else {
                document.getElementById('appointmentDetails').innerHTML = 
                    '<p class="error-message">ID do agendamento n√£o fornecido.</p>';
            }
        });
    </script>
</body>
</html>